#ifndef TPOPULATION_H
#define TPOPULATION_H

#include "TAgent.h"
#include "TEnvironment.h"
#include <string>

/*
Класс популяции нейросетевых агентов
*/
class TPopulation{
	// Список агентов в популяции
	TAgent** agents;
	// Кол-во агентов в популяции
	int populationSize;
	// Текущий последний номер инновации связей популяции
	long connectionInnovationNumber;
	// Текущий последний номер инновации предикторных связей популяции
	long predConnectionInnovationNumber;

	// Очистка популяции
	void erasePopulation(){
		if (agents){
			for (int currentAgent = 1; currentAgent <= populationSize; ++currentAgent)
				if (agents[currentAgent - 1])
					delete agents[currentAgent - 1];
			delete []agents;
			agents = 0;
			connectionInnovationNumber = 0;
			predConnectionInnovationNumber = 0;
			populationSize = 0;
		}
	}
	// ---------------  Различные процедуры мутации -------------------------
	// Процедура мутации - мутация весовых коэффициентов связи
	void mutationConnectionsWeight(TAgent& kidAgent);
	// Процедура мутации - включения/выключения связей
	void mutationEnableDisableConnections(TAgent& kidAgent, int currentEvolutionStep);
	// Процедура мутации - включения/выключения предикторных связей
	void mutationEnableDisablePredConnections(TAgent& kidAgent, int currentEvolutionStep);
	// Процедура мутации - удаления из агента связей, которые выключены более некоторого количества поколений
	void mutationDeleteConnectionPopulation(TAgent& kidAgent, int currentEvolutionStep);
	// Процедура мутации - удаления из агента предикторных связей, которые выключены более некоторого количества поколений
	void mutationDeletePredConnectionPopulation(TAgent& kidAgent, int currentEvolutionStep);
	// Процедура мутации - добавление связи
	void mutationAddPoolConnection(TAgent& kidAgent);
	// Процедура мутации - добавление предикторной связи
	void mutationAddPoolPredConnection(TAgent& kidAgent);
	// Процедура мутации - удаление связи
	void mutationDeletePoolConnection(TAgent& kidAgent);
	// Процедура мутации - удаление предикторной связи
	void mutationDeletePoolPredConnection(TAgent& kidAgent);
	// Коэффициент уменьшения вероятности дупликации пула с ростом генома
	double duplicateDivision(int poolsQuantity, int connectionsQuantity);
	// Процедура мутации - дупликация пула
	void mutationPoolDuplication(TAgent& kidAgent);
	// Процедура мутации вероятности развития синапса по связи между пулами
	void mutationDevelopSynapseProb(TAgent& KidAgent);
	// Процедура мутации вероятности развития предикторной связи по предикторной связи между пулами
	void mutationDevelopPredConProb(TAgent& KidAgent);
	// Процедура составления потомка от двух родителей
	void composeOffspringFromParents(TAgent& kidAgent, const TAgent& firstParentAgent, const TAgent& secondParentAgent);
	// Процедура генерации одного потомка
	void generateOffspring(TAgent& kidAgent, const TAgent& firstParentAgent, const TAgent& secondParentAgent, int currentEvolutionStep);
	//Процедура получения номера агента, используемая в рулеточном алгоритме
	int rouletteWheelSelection(double populationFitness[]);
	// Процедура генерации нового поколения и замены старого на новое
	void generateNextPopulation(int currentEvolutionStep);

public:
	// Структура параметры эволюции
	struct SEvolutionSettings{
		int evolutionTime; // Кол-во тактов эволюции
		int agentLifetime; // Кол-во тактов жизни агента
	} evolutionSettings;

	// Структура "Найстройки мутационных процедур" (сюда включаются необходимые константы, относящиеся к мутациям)
	struct SMutationSettings{
		 double mutWeightProbability; // Вероятность мутации веса связи
		double mutWeightMeanDisp; // Дисперсия значения мутации веса связи
		double mutWeightDispDisp; // Дисперсия значения мутации дисперсии связи
		int disLimit;  // Максимальное кол-во тактов, после которого выключенная связь удаляется из генома
		double enableConnectionProb; // Вероятность включения выключенной связи
		double disableConnectionProb; // Вероятность выключения включенной связи
		double addConnectionProb; // Вероятность вставки связи
		double addPredConnectionProb; // Вероятность вставки предикторной связи
		double deleteConnectionProb; // Вероятность удаления связи
		double deletePredConnectionProb; //  Вероятность удаления предикторной связи
		double duplicatePoolProb;  // Вероятность дуплицирования нейронального пула (модернизированный эволюционный алгоритм)
		double poolDivisionCoef; // Коэффициент уменьшения размерности пула при его деления в процедуре дупликации пула
		int poolStandartAmount; // Стандартный размер сети в кол-ве пулов(для использования в процедуре дупликации нейрона)
		int connectionStandartAmount; // Стандартное кол-во связей в сети
		double mutDevelopConProbProb; // Вероятность мутации вероятности образования связи связи
		double mutDevelopConProbDisp; // Дисперсия мутации вероятности образования связи связи
	} mutationSettings;

	// Конструктор по умолчанию
	TPopulation(){
		agents = 0;
		populationSize = 0;
		connectionInnovationNumber = 0;
		predConnectionInnovationNumber = 0;
	}
	// Конструктор сразу с загрузкой геномов агентов
	TPopulation(std::string populationFilename, int _populationSize){
		loadPopulation(populationFilename, _populationSize);
	}
	// Деструктор
	~TPopulation(){ 
		erasePopulation();
	}
	// Геттеры и сеттеры
	int getPopulationSize() const { return populationSize; }
	// Изменение размера популяции (изменяется не только само значение, но и удаляется старая популяция и создается пустая новая)
	void setPopulationSize(int _populationSize){ 
		if (agents)	erasePopulation();
		populationSize = _populationSize;
		agents = new TAgent*[populationSize];
		for (int currentAgent = 1; currentAgent <= populationSize; ++currentAgent)
			agents[currentAgent - 1] = new TAgent;
	}
	TAgent* getPointertoAgent(int agentNumber) const { return agents[agentNumber - 1]; }

	// Загрузка популяции геномов из файла (если размер популяции не передается, то значение берется из текущих параметров популяции)
	void loadPopulation(std::string populationFilename, int _populationSize = 0);

	// Выгрузка популяции геномов в файл
	void uploadPopulation(std::string populationFilename) const;

	// Генерация минимальной популяции (если размер популяции не передается, то значение берется из текущих параметров популяции)
	void generateMinimalPopulation(int inputResolution, int _populationSize = 0);

	// Шаг эволюционного процесса
	void evolutionaryStep(TEnvironment& environment, int evolutionStepNumber);

	// Процедура эволюции популяции
	void evolution(TEnvironment& environment);

	// Копирование популяции (создание всех новых структур)
	TPopulation& operator=(const TPopulation& sourcePopulation);

	friend class tests;
};

#endif // TPOPULATION_H
